// <auto-generated>
// This file is auto-generated by Paramore.Brighter.Test.Generator
// </auto-generated>

using Xunit;
using System;
using System.Collections.Generic;
using System.Linq;

namespace {{ Namespace }}.Outbox{{ Prefix }}.Sync;

public class WhenRetrievingAMessageByIdItShouldReturnTheCorrectMessage : IDisposable
{
    private readonly IAmAnOutboxProviderSync _outboxProvider;
    private readonly IAmAMessageFactory _messageFactory;
    private List<Message> _createdMessages = [];

    public WhenRetrievingAMessageByIdItShouldReturnTheCorrectMessage()
    {
        _outboxProvider = new {{ OutboxProvider }}();
        _outboxProvider.CreateStore();

        _messageFactory = new {{ MessageFactory }}();
    }

    [Fact]
    public void When_Retrieving_A_Message_By_Id_It_Should_Return_The_Correct_Message()
    {
        // Arrange
        var context = new RequestContext();
        var earliest = _messageFactory.Create();
        var dispatched = _messageFactory.Create();
        var undispatched = _messageFactory.Create();

        _createdMessages.Add(earliest);
        _createdMessages.Add(dispatched);
        _createdMessages.Add(undispatched);
        
        var outbox = _outboxProvider.CreateOutbox();
        outbox.Add([earliest, dispatched, undispatched], context);
        outbox.MarkDispatched(earliest.Id, context, DateTime.UtcNow.AddHours(-3));
        outbox.MarkDispatched(dispatched.Id, context);
        
        // Act
        var message = outbox.Get(dispatched.Id, context);

        // Assert
        Assert.NotNull(message);
        Assert.Equal(message.Body.Value, dispatched.Body.Value);

        //should read the header from the sql outbox
        Assert.Equal(message.Header.Topic, dispatched.Header.Topic);
        Assert.Equal(message.Header.MessageType, dispatched.Header.MessageType);
        Assert.Equal(message.Header.TimeStamp.ToString("yyyy-MM-ddTHH:mm:ss.fZ"), dispatched.Header.TimeStamp.ToString("yyyy-MM-ddTHH:mm:ss.fZ"));
        Assert.Equal(0, dispatched.Header.HandledCount); // -- should be zero when read from outbox
        Assert.Equal(TimeSpan.Zero, dispatched.Header.Delayed); // -- should be zero when read from outbox
        Assert.Equal(message.Header.CorrelationId, dispatched.Header.CorrelationId);
        Assert.Equal(message.Header.ReplyTo, dispatched.Header.ReplyTo);
        Assert.StartsWith(message.Header.ContentType.ToString(), dispatched.Header.ContentType.ToString());
        Assert.Equal(message.Header.PartitionKey, dispatched.Header.PartitionKey); 
            
        //Bag serialization
        Assert.Equal(message.Header.Bag.Count,  dispatched.Header.Bag.Count);
        foreach (var (key, val) in message.Header.Bag)
        {
            Assert.Contains(key, dispatched.Header.Bag);
            Assert.Equal(val,  dispatched.Header.Bag[key].ToString());
        }
            
        //Asserts for workflow properties
        Assert.Equal(message.Header.WorkflowId, dispatched.Header.WorkflowId);
        Assert.Equal(message.Header.JobId, dispatched.Header.JobId);

        // new fields assertions
        Assert.Equal(message.Header.Source,       dispatched.Header.Source);
        Assert.Equal(message.Header.Type,         dispatched.Header.Type);
        Assert.Equal(message.Header.DataSchema,   dispatched.Header.DataSchema);
        Assert.Equal(message.Header.Subject,      dispatched.Header.Subject);
        Assert.Equal(message.Header.TraceParent,  dispatched.Header.TraceParent);
        Assert.Equal(message.Header.TraceState,   dispatched.Header.TraceState);
    }

    public void Dispose()
    {
        _outboxProvider.DeleteStore(_createdMessages);
    }
}
