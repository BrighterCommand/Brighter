// <auto-generated>
// This file is auto-generated by Paramore.Brighter.Test.Generator
// </auto-generated>

using Xunit;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace {{ Namespace }}.Outbox{{ Prefix }}.Async;

public class WhenAddingAMessageWithinTransactionAndRollbackItShouldNotBeStoredAsync : IAsyncLifetime
{
    private readonly IAmAnOutboxProviderAsync _outboxProvider;
    private readonly IAmAMessageFactory _messageFactory;
    private List<Message> _createdMessages = [];

    public WhenAddingAMessageWithinTransactionAndRollbackItShouldNotBeStoredAsync()
    {
        _outboxProvider = new {{ OutboxProvider }}();

        _messageFactory = new {{ MessageFactory }}();
    }

    public async Task InitializeAsync()
    {
        await _outboxProvider.CreateStoreAsync();
    }

    public async Task DisposeAsync()
    {
        await _outboxProvider.DeleteStoreAsync(_createdMessages);
    }

    [Fact]
    public async Task When_Adding_A_Message_Within_Transaction_And_Rollback_It_Should_Not_Be_Stored_Async()
    {
        // Arrange
        var outbox = _outboxProvider.CreateOutboxAsync();

        var transaction = _outboxProvider.CreateTransactionProvider();
        _ = await transaction.GetTransactionAsync();

        var context = new RequestContext();
        var message = _messageFactory.Create();

        _createdMessages.Add(message);

        // Act
        await outbox.AddAsync(message, context, transactionProvider: transaction);
        await transaction.RollbackAsync();

        var storedMessage = await outbox.GetAsync(message.Id, context);
        
        // Assert
        Assert.Equal(MessageType.MT_NONE, storedMessage.Header.MessageType);
    }
}
