// <auto-generated>
// This file is auto-generated by Paramore.Brighter.Test.Generator
// </auto-generated>

using Xunit;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace Paramore.Brighter.Gcp.Tests.Outbox.SpannerText.Async;

[Trait("Category", "Spanner")]
public class WhenAddingAMessageWithinTransactionItShouldBeStoredAfterCommitAsync : IAsyncLifetime
{
    private readonly IAmAnOutboxProviderAsync _outboxProvider;
    private readonly IAmAMessageFactory _messageFactory;
    private List<Message> _createdMessages = [];

    public WhenAddingAMessageWithinTransactionItShouldBeStoredAfterCommitAsync()
    {
        _outboxProvider = new SpannerTextOutboxProvider();

        _messageFactory = new DefaultMessageFactory();
    }

    public async ValueTask InitializeAsync()
    {
        await _outboxProvider.CreateStoreAsync();
    }

    public async ValueTask DisposeAsync()
    {
        await _outboxProvider.DeleteStoreAsync(_createdMessages);
    }

    [Fact]
    public async Task When_Adding_A_Message_Within_Transaction_It_Should_Be_Stored_After_Commit_Async()
    {
        // Arrange
        var outbox = _outboxProvider.CreateOutboxAsync();

        var transaction = _outboxProvider.CreateTransactionProvider();
        _ = await transaction.GetTransactionAsync();

        var context = new RequestContext();
        var message = _messageFactory.Create();

        _createdMessages.Add(message );

        // Act
        await outbox.AddAsync(message, context, transactionProvider: transaction);
        await transaction.CommitAsync();
        
        var storedMessage = await outbox.GetAsync(message.Id, context);
        
        // Assert
        Assert.Equal(message.Body.Value, storedMessage.Body.Value);
        
        //should read the header from the sql outbox
        Assert.Equal(message.Header.Topic, storedMessage.Header.Topic);
        Assert.Equal(message.Header.MessageType, storedMessage.Header.MessageType);
        Assert.Equal(message.Header.TimeStamp.ToString("yyyy-MM-ddTHH:mm:ss.fZ"), storedMessage.Header.TimeStamp.ToString("yyyy-MM-ddTHH:mm:ss.fZ"));
        Assert.Equal(0, storedMessage.Header.HandledCount); // -- should be zero when read from outbox
        Assert.Equal(TimeSpan.Zero, storedMessage.Header.Delayed); // -- should be zero when read from outbox
        Assert.Equal(message.Header.CorrelationId, storedMessage.Header.CorrelationId);
        Assert.Equal(message.Header.ReplyTo, storedMessage.Header.ReplyTo);
        Assert.StartsWith(message.Header.ContentType.ToString(), storedMessage.Header.ContentType.ToString());
        Assert.Equal(message.Header.PartitionKey, storedMessage.Header.PartitionKey); 
            
        //Bag serialization
        Assert.Equal(message.Header.Bag.Count,  storedMessage.Header.Bag.Count);
        foreach (var (key, val) in message.Header.Bag)
        {
            Assert.Contains(key, storedMessage.Header.Bag);
            Assert.Equal(val,  storedMessage.Header.Bag[key].ToString());
        }
            
        //Asserts for workflow properties
        Assert.Equal(message.Header.WorkflowId, storedMessage.Header.WorkflowId);
        Assert.Equal(message.Header.JobId, storedMessage.Header.JobId);

        // new fields assertions
        Assert.Equal(message.Header.Source,       storedMessage.Header.Source);
        Assert.Equal(message.Header.Type,         storedMessage.Header.Type);
        Assert.Equal(message.Header.DataSchema,   storedMessage.Header.DataSchema);
        Assert.Equal(message.Header.Subject,      storedMessage.Header.Subject);
        Assert.Equal(message.Header.TraceParent,  storedMessage.Header.TraceParent);
        Assert.Equal(message.Header.TraceState,   storedMessage.Header.TraceState);
    }
}
