// <auto-generated>
// This file is auto-generated by Paramore.Brighter.Test.Generator
// </auto-generated>

using Xunit;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace Paramore.Brighter.Gcp.Tests.Outbox.SpannerText.Async;

[Trait("Category", "Spanner")]
public class WhenDeletingMultipleMessagesTheyShouldBeRemovedFromOutboxAsync : IAsyncLifetime
{
    private readonly IAmAnOutboxProviderAsync _outboxProvider;
    private readonly IAmAMessageFactory _messageFactory;
    private List<Message> _createdMessages = [];

    public WhenDeletingMultipleMessagesTheyShouldBeRemovedFromOutboxAsync()
    {
        _outboxProvider = new SpannerTextOutboxProvider();
        _messageFactory = new DefaultMessageFactory();
    }

    public async ValueTask InitializeAsync()
    {
        await _outboxProvider.CreateStoreAsync();
    }

    public async ValueTask DisposeAsync()
    {
        await _outboxProvider.DeleteStoreAsync(_createdMessages);
    }

    [Fact]
    public async Task When_Deleting_Multiple_Messages_They_Should_Be_Removed_From_Outbox_Async()
    {
        // Arrange
        var context = new RequestContext();
        var firstMessage = _messageFactory.Create();
        var secondMessage = _messageFactory.Create();
        var thirdMessage = _messageFactory.Create();

        _createdMessages.Add(firstMessage);
        _createdMessages.Add(secondMessage);
        _createdMessages.Add(thirdMessage);
        
        // Act
        var outbox = _outboxProvider.CreateOutboxAsync();
        await outbox.AddAsync(firstMessage, context);
        await outbox.AddAsync(secondMessage, context);
        await outbox.AddAsync(thirdMessage, context);
        
        await outbox.DeleteAsync([firstMessage.Id, secondMessage.Id, thirdMessage.Id], context);
        
        // Assert
        var messages = (await outbox
            .OutstandingMessagesAsync(TimeSpan.Zero, context))
            .ToArray();

        Assert.DoesNotContain(firstMessage.Id, messages.Select(x => x.Id));
        Assert.DoesNotContain(secondMessage.Id, messages.Select(x => x.Id));
        Assert.DoesNotContain(thirdMessage.Id, messages.Select(x => x.Id));   
    }
}
