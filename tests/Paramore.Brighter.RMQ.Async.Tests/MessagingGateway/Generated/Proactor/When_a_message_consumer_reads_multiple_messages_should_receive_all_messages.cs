// <auto-generated>
// This file is auto-generated by Paramore.Brighter.Test.Generator
// </auto-generated>

using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

using Xunit;


using Paramore.Brighter.Extensions;

namespace Paramore.Brighter.RMQ.Async.Tests.MessagingGateway.Proactor;

public class WhenAMessageConsumerReadsMultipleMessagesShouldReceiveAllMessages : IAsyncLifetime
{
    private readonly IAmAMessageGatewayProactorProvider _messageGatewayProvider;
    private readonly IAmAMessageFactory _messageFactory;
    private readonly IAmAMessageAssertion _messageAssertion;

    private Paramore.Brighter.MessagingGateway.RMQ.Async.RmqSubscription? _subscription;
    private Paramore.Brighter.MessagingGateway.RMQ.Async.RmqPublication? _publication;

    private IAmAMessageProducerAsync? _producer;
    private IAmAChannelAsync? _channel;


    public WhenAMessageConsumerReadsMultipleMessagesShouldReceiveAllMessages()
    {
        _messageGatewayProvider = new Paramore.Brighter.RMQ.Async.Tests.MessagingGateway.RmqMessageGatewayProvider();
        _messageFactory = new DefaultMessageFactory();
        _messageAssertion = new DefaultMessageAssertion();
    }

    public Task InitializeAsync()
    {
        return Task.CompletedTask;
    }

    public async Task DisposeAsync()
    {
        await _messageGatewayProvider.CleanUpAsync(_producer, _channel);
    }

    [Fact]
    public async Task When_a_message_consumer_reads_multiple_messages_should_receive_all_messages_async()
    {
        // Arrange
        _publication = _messageGatewayProvider.CreatePublication(_messageGatewayProvider.GetOrCreateRoutingKey());
        _subscription = _messageGatewayProvider.CreateSubscription(_publication.Topic!, 
            _messageGatewayProvider.GetOrCreateChannelName(),
            OnMissingChannel.Create);

        _producer = await _messageGatewayProvider.CreateProducerAsync(_publication);
        _channel = await _messageGatewayProvider.CreateChannelAsync(_subscription);

        List<Message> messages =
        [
          _messageFactory.Create(new MessageConfiguration{Topic = _publication.Topic, PartitionKey = null}),
          _messageFactory.Create(new MessageConfiguration{Topic = _publication.Topic, PartitionKey = null}),
          _messageFactory.Create(new MessageConfiguration{Topic = _publication.Topic, PartitionKey = null}),
          _messageFactory.Create(new MessageConfiguration{Topic = _publication.Topic, PartitionKey = null})
        ];

        // Act
        await messages.EachAsync(async message => await _producer.SendAsync(message));

        await Task.Delay(5000);

        // Assert
        for (var i = 0; i < messages.Count; i++)
        {
            var received = await _channel.ReceiveAsync(null);

            Assert.NotEqual(MessageType.MT_NONE,  received.Header.MessageType);

            var expectedMessage = messages.FirstOrDefault(x => x.Header.MessageId == received.Header.MessageId);
            Assert.NotNull(expectedMessage);

            _messageAssertion.Assert(expectedMessage, received);

            await _channel.AcknowledgeAsync(received);

            if ((i + 1) % _subscription.BufferSize == 0)
            {
                await Task.Delay(5000);
            }
        }
    }
}
