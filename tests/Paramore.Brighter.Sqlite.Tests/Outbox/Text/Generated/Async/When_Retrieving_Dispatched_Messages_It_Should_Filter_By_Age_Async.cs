// <auto-generated>
// This file is auto-generated by Paramore.Brighter.Test.Generator
// </auto-generated>

using Xunit;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace Paramore.Brighter.Sqlite.Tests.Outbox.Text.Async;

public class WhenRetrievingDispatchedMessagesItShouldFilterByAgeAsync : IAsyncLifetime
{
    private readonly IAmAnOutboxProviderAsync _outboxProvider;
    private readonly IAmAMessageFactory _messageFactory;
    private List<Message> _createdMessages = [];

    public WhenRetrievingDispatchedMessagesItShouldFilterByAgeAsync()
    {
        _outboxProvider = new SqliteTextOutboxProvider();

        _messageFactory = new DefaultMessageFactory();
    }

    public async ValueTask InitializeAsync()
    {
        await _outboxProvider.CreateStoreAsync();
    }

    public async ValueTask DisposeAsync()
    {
        await _outboxProvider.DeleteStoreAsync(_createdMessages);
    }

    [Fact]
    public async Task When_Retrieving_Dispatched_Messages_It_Should_Filter_By_Age_Async()
    {
        // Arrange
        var context = new RequestContext();
        var earliest = _messageFactory.Create();
        var dispatched = _messageFactory.Create();
        var undispatched = _messageFactory.Create();

        _createdMessages.Add(earliest);
        _createdMessages.Add(dispatched);
        _createdMessages.Add(undispatched);
        
        var outbox = _outboxProvider.CreateOutboxAsync();
        await outbox.AddAsync([earliest, dispatched, undispatched], context);
        await outbox.MarkDispatchedAsync(earliest.Id, context, DateTime.UtcNow.AddHours(-3));
        await outbox.MarkDispatchedAsync(dispatched.Id, context);
        
        // Act
        var allDispatched = (await outbox.DispatchedMessagesAsync(TimeSpan.Zero, context)).ToArray();
        var messagesOverAnHour  = (await outbox.DispatchedMessagesAsync(TimeSpan.FromHours(1), context)).ToArray();
        var messagesOver4Hours   = (await outbox.DispatchedMessagesAsync(TimeSpan.FromHours(4), context)).ToArray();

        // Assert
        Assert.True(allDispatched.Length >= 2, "Expecting at least 2 messages");
        Assert.Contains(earliest.Id, allDispatched.Select(x => x.Id));
        Assert.Contains(dispatched.Id, allDispatched.Select(x => x.Id));
        Assert.DoesNotContain(undispatched.Id, allDispatched.Select(x => x.Id));
        
        Assert.True(messagesOverAnHour.Length >= 1, "Expecting at least 1 message");
        Assert.Contains(earliest.Id, messagesOverAnHour.Select(x => x.Id));
        Assert.DoesNotContain(dispatched.Id, messagesOverAnHour.Select(x => x.Id));
        Assert.DoesNotContain(undispatched.Id, messagesOverAnHour.Select(x => x.Id));
        
        Assert.DoesNotContain(earliest.Id, messagesOver4Hours.Select(x => x.Id));
        Assert.DoesNotContain(dispatched.Id, messagesOver4Hours.Select(x => x.Id));
        Assert.DoesNotContain(undispatched.Id, messagesOver4Hours.Select(x => x.Id));
    }
}
