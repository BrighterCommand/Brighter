// <auto-generated>
// This file is auto-generated by Paramore.Brighter.Test.Generator
// </auto-generated>

using Xunit;
using System;
using System.Collections.Generic;
using System.Linq;

namespace Paramore.Brighter.PostgresSQL.Tests.Outbox.Binary.Sync;

public class WhenRetrievingAllMessagesTheyShouldIncludeDispatchedAndUndispatched : IDisposable
{
    private readonly IAmAnOutboxProviderSync _outboxProvider;
    private readonly IAmAMessageFactory _messageFactory;
    private List<Message> _createdMessages = [];

    public WhenRetrievingAllMessagesTheyShouldIncludeDispatchedAndUndispatched()
    {
        _outboxProvider = new PostgresBinaryOutboxProvider();
        _outboxProvider.CreateStore();

        _messageFactory = new DefaultMessageFactory();
    }

    [Fact]
    public void When_Retrieving_All_Messages_They_Should_Include_Dispatched_And_Undispatched()
    {
        // Arrange
        var context = new RequestContext();
        var earliest = _messageFactory.Create();
        var dispatched = _messageFactory.Create();
        var undispatched = _messageFactory.Create();

        _createdMessages.Add(earliest);
        _createdMessages.Add(dispatched);
        _createdMessages.Add(undispatched);
        
        var outbox = _outboxProvider.CreateOutbox();
        outbox.Add([earliest, dispatched, undispatched], context);
        outbox.MarkDispatched(earliest.Id, context, DateTime.UtcNow.AddHours(-3));
        outbox.MarkDispatched(dispatched.Id, context);
        
        // Act
        var messages = _outboxProvider.GetAllMessages().ToArray();

        // Assert
        Assert.True(messages.Length >= 3, "Expecting at least 3 messages");
        Assert.Contains(earliest.Id, messages.Select(x => x.Id));
        Assert.Contains(dispatched.Id, messages.Select(x => x.Id));
        Assert.Contains(undispatched.Id, messages.Select(x => x.Id));
    }

    public void Dispose()
    {
        _outboxProvider.DeleteStore(_createdMessages);
    }
}
